'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createEpic;

var _invariant = require('invariant');

var _invariant2 = _interopRequireDefault(_invariant);

var _rx = require('rx');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Saga(
//   action$: Observable[Action],
//   getState: () => Object,
//   dependencies: Object
// ) => Observable[Action]
//
// interface EpicMiddleware {
//   ({
//     dispatch: Function,
//     getState: Function
//   }) => next: Function => action: Action => Action,
//   // used to dispose sagas
//   dispose() => Void,
//
//   // the following are internal methods
//   // they may change without warning
//   restart() => Void,
//   end() => Void,
//   subscribe() => Disposable,
//   subscribeOnCompleted() => Disposable,
//
// }
//
// createEpic(
//   depndencies: Object|Saga,
//   ...sagas: Saga[]
// ) => EpicMiddleware

function createEpic(dependencies) {
  for (var _len = arguments.length, sagas = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    sagas[_key - 1] = arguments[_key];
  }

  if (typeof dependencies === 'function') {
    sagas.push(dependencies);
    dependencies = {};
  }
  var action$ = void 0;
  var lifecycle = void 0;
  var compositeDisposable = void 0;
  var start = void 0;
  function epicMiddleware(_ref) {
    var dispatch = _ref.dispatch;
    var getState = _ref.getState;

    start = function start() {
      compositeDisposable = new _rx.CompositeDisposable();
      action$ = new _rx.Subject();
      lifecycle = new _rx.Subject();
      var sagaSubscription = _rx.Observable.from(sagas)
      // need to test for pass-through sagas
      .map(function (saga) {
        return saga(action$, getState, dependencies);
      }).doOnNext(function (result$) {
        !_rx.Observable.isObservable(result$) ? process.env.NODE_ENV !== 'production' ? (0, _invariant2.default)(false, 'saga should returned an observable but got %s', result$) : (0, _invariant2.default)(false) : void 0;
        !(result$ !== action$) ? process.env.NODE_ENV !== 'production' ? (0, _invariant2.default)(false, 'saga should not be an identity function') : (0, _invariant2.default)(false) : void 0;
      }).mergeAll().filter(function (action) {
        return action && typeof action.type === 'string';
      }).subscribe(function (action) {
        return dispatch(action);
      }, function (err) {
        throw err;
      }, function () {
        return lifecycle.onCompleted();
      });
      compositeDisposable.add(sagaSubscription);
    };
    start();
    return function (next) {
      return function (action) {
        var result = next(action);
        action$.onNext(action);
        return result;
      };
    };
  }

  epicMiddleware.subscribe = function () {
    for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
      args[_key2] = arguments[_key2];
    }

    return lifecycle.subscribe.apply(lifecycle, args);
  };
  epicMiddleware.subscribeOnCompleted = function () {
    for (var _len3 = arguments.length, args = Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
      args[_key3] = arguments[_key3];
    }

    return lifecycle.subscribeOnCompleted.apply(lifecycle, args);
  };
  epicMiddleware.end = function () {
    return action$.onCompleted();
  };
  epicMiddleware.dispose = function () {
    return compositeDisposable.dispose();
  };
  epicMiddleware.restart = function () {
    epicMiddleware.dispose();
    action$.dispose();
    start();
  };
  return epicMiddleware;
}